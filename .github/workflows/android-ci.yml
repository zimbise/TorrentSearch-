 name: Checkout
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: Set up JDK 11
    uses: actions/setup-java@v4
    with:
      distribution: temurin
      java-version: '11'

  - name: Cache Gradle
    uses: actions/cache@v4
    with:
      path: |
        ~/.gradle/caches
        ~/.gradle/wrapper
      key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
      restore-keys: |
        gradle-${{ runner.os }}-

  - name: Install Android SDK
    run: |
      set -e
      sudo apt-get update -qq
      sudo apt-get install -y -qq wget unzip
      mkdir -p "$ANDROID_SDK_ROOT"
      cd "$ANDROID_SDK_ROOT"
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
      unzip -q cmdline-tools.zip
      mkdir -p cmdline-tools/latest
      mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
      export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
      yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses 2>/dev/null || true
      sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-36" "build-tools;34.0.0" 2>/dev/null || true

  - name: Setup environment for build
    run: |
      echo "ANDROID_SDK_ROOT=${{ github.runner_temp }}/android-sdk" >> $GITHUB_ENV
      echo "${{ github.runner_temp }}/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH

  - name: Make gradlew executable
    run: chmod +x ./gradlew

  - name: Build non-debuggable APK
    run: |
      ./gradlew clean :app:assembleUserDebug \
        --no-daemon \
        --stacktrace \
        -Dorg.gradle.jvmargs=-Xmx4g \
        --warning-mode all

  - name: Verify APK
    run: |
      if [ ! -f "app/build/outputs/apk/userDebug/app-userDebug.apk" ]; then
        echo "ERROR: APK not found at expected location!"
        exit 1
      fi
      echo "APK built successfully at:"
      ls -lh app/build/outputs/apk/userDebug/app-userDebug.apk

  - name: Upload to Artifacts (90 days)
    uses: actions/upload-artifact@v4
    with:
      name: app-userDebug-apk
      path: app/build/outputs/apk/userDebug/app-userDebug.apk
      retention-days: 90

  - name: Create Permanent Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: softprops/action-gh-release@v1
    with:
      files: app/build/outputs/apk/userDebug/app-userDebug.apk
      tag_name: nightly-${{ github.run_number }}
      name: "Nightly Build #${{ github.run_number }}"
      body: |
        ✅ **Non-Debuggable APK - Ready to Use**
        
        Automatic nightly build from commit ${{ github.sha }}
        
        **Features:**
        - Non-debuggable (safe for regular use)
        - All Jackett/Torznab integration included
        - All provider fixes applied
        - Fully functional testing APK
        
        **Installation:**
        ```bash
        # Option 1: Direct file transfer
        adb install -r app-userDebug.apk
        
        # Option 2: Transfer to phone and install via file manager
        ```
        
        **What's Included:**
        - ✅ Jackett API key integration
        - ✅ Sync button for provider refresh
        - ✅ All built-in torrent providers
        - ✅ Material 3 UI
        - ✅ Search history & bookmarks
        - ✅ Safe mode filtering
        
        Built from: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
      prerelease: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  - name: Update "latest" Release Tag
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    run: |
      git config --global user.name "github-actions[bot]"
      git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      git tag -d latest 2>/dev/null || true
      git push origin :refs/tags/latest 2>/dev/null || true
      git tag latest
      git push origin latest --force

  - name: Build Status Summary
    if: always()
    run: |
      echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "- **Variant**: userDebug (non-debuggable)" >> $GITHUB_STEP_SUMMARY
      echo "- **Target API**: 36 (Android 15)" >> $GITHUB_STEP_SUMMARY
      echo "- **Min API**: 25 (Android 7.1+)" >> $GITHUB_STEP_SUMMARY
      echo "- **Signing**: Debug key (safe for testing)" >> $GITHUB_STEP_SUMMARY
      echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### Download" >> $GITHUB_STEP_SUMMARY
      echo "[⬇️ Latest APK](https://github.com/${{ github.repository }}/releases/tag/latest)" >> $GITHUB_STEP_SUMMARY
